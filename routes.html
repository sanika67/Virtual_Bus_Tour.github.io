<!DOCTYPE html>
<html lang="en" ng-app="routesApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routes - SwiftBus</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- General Styling & Theming --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-color: #2563EB; --secondary-color: #10B981; --accent-color: #F59E0B;
            --bg-light: #F8FAFC; --bg-white: #FFFFFF; --text-dark: #1E293B;
            --text-gray: #64748B; --border-color: #E2E8F0;
        }
        [data-theme="dark"] {
            --primary-color: #3B82F6; --bg-light: #0F172A; --bg-white: #1E293B;
            --text-dark: #F1F5F9; --text-gray: #94A3B8; --border-color: #334155;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6; color: var(--text-dark); background-color: var(--bg-light);
            padding-top: 70px; /* To offset the fixed navbar */
        }

        /* --- Navbar --- */
        .navbar { background: var(--bg-white); box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: fixed; width: 100%; top: 0; z-index: 1000; }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .logo { font-size: 28px; font-weight: bold; color: var(--primary-color); text-decoration: none; }
        .nav-menu { display: flex; list-style: none; gap: 30px; align-items: center; }
        .nav-menu a, .nav-menu .auth-links a { text-decoration: none; color: var(--text-dark); font-weight: 500; transition: color 0.3s ease; }
        .nav-menu a:hover { color: var(--primary-color); }
        .auth-links { display: flex; gap: 15px; align-items: center; }
        .btn-nav { padding: 8px 16px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; }
        .btn-nav.login { border: 2px solid var(--primary-color); color: var(--primary-color); }
        .btn-nav.login:hover { background: var(--primary-color); color: white; }
        .btn-nav.signup { background: var(--primary-color); color: white; }
        .btn-nav.signup:hover { background: #1d4ed8; }
        .theme-toggle { background: var(--primary-color); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 16px; }

        /* --- Page Layout --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .page-header { padding-top: 50px; text-align: center; margin-bottom: 60px; }
        .page-header h1 { font-size: 3rem; }
        .page-header p { font-size: 1.2rem; color: var(--text-gray); max-width: 600px; margin: 15px auto 0; }
        .routes-layout { display: grid; grid-template-columns: 280px 1fr; gap: 30px; }

        /* --- Filters & Bus List --- */
        .filters-sidebar { background: var(--bg-white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); align-self: start; }
        .filter-group { margin-bottom: 25px; }
        .filter-group h3 { margin-bottom: 15px; font-size: 1.2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .filter-option label { display: flex; align-items: center; gap: 10px; color: var(--text-gray); cursor: pointer; }
        .filter-option input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary-color); }
        #route-results-info { margin-bottom: 20px; padding: 15px; border-radius: 8px; background: var(--bg-white); font-weight: 500; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .bus-result-card { background: var(--bg-white); border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s ease; border: 1px solid var(--border-color); margin-bottom: 20px; }
        .bus-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .bus-operator h3 { margin: 0 0 5px 0; font-size: 1.3rem; }
        .bus-type { background: var(--bg-light); color: var(--text-gray); padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; }
        .bus-rating { background: var(--secondary-color); color: white; padding: 6px 12px; border-radius: 15px; font-weight: 500; font-size: 0.9rem; }
        .bus-footer { display: flex; justify-content: space-between; align-items: center; }
        .price-info { display: flex; flex-direction: column; gap: 4px; }
        .price { font-size: 1.8rem; font-weight: bold; color: var(--primary-color); }
        .seats-left { color: var(--accent-color); font-size: 0.9rem; font-weight: 500; }
        .view-seats-btn { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; }

        /* --- ALL MODAL STYLES (Seat Selection, Booking, Payment) --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        .modal-content { position: relative; background: var(--bg-white); border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal.show .modal-content { transform: scale(1); }
        .modal-header { background: var(--primary-color); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .close-modal { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        
        .seat-selection-modal .modal-content { width: 95%; max-width: 1200px; height: 90vh; }
        .bus-info-bar { background: var(--bg-light); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .seat-selection-container { flex: 1; display: grid; grid-template-columns: 1fr 300px; overflow: hidden; }
        .bus-layout { padding: 30px; overflow-y: auto; background: var(--bg-light); }
        .driver-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .steering { font-size: 24px; color: var(--text-gray); }
        .seats-grid { background: var(--bg-white); border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .seat-row { display: grid; grid-template-columns: 60px 60px 40px 60px 60px; gap: 10px; margin-bottom: 12px; justify-content: center; }
        .seat { width: 50px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; position: relative; border: 2px solid transparent; }
        .seat.available { background: var(--secondary-color); color: white; }
        .seat.booked { background: #EF4444; color: white; cursor: not-allowed; }
        .seat.selected { background: var(--accent-color); color: white; }
        .seat.window { border: 2px solid var(--primary-color); }
        .legend { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .seat-demo { width: 20px; height: 20px; border-radius: 4px; }
        .seat-demo.available { background: var(--secondary-color); } .seat-demo.booked { background: #EF4444; } .seat-demo.selected { background: var(--accent-color); } .seat-demo.window { background: var(--secondary-color); border: 2px solid var(--primary-color);}
        .selection-summary { background: var(--bg-white); padding: 30px; border-left: 1px solid var(--border-color); }
        .selection-summary h3 { margin-top: 0; margin-bottom: 20px; }
        .selected-seat-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .price-breakdown { margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color); }
        .total-price { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); text-align: center; }
        .proceed-btn { width: 100%; background: var(--primary-color); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .proceed-btn:disabled { background: var(--text-gray); cursor: not-allowed; }

        .booking-process-modal .modal-content { width: 95%; max-width: 950px; height: auto; max-height: 90vh; }
        .booking-main-content { display: grid; grid-template-columns: 320px 1fr; flex: 1; overflow: hidden; }
        .booking-summary-sidebar { background: var(--bg-light); padding: 30px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 15px; }
        .summary-total { margin-top: auto; padding-top: 20px; border-top: 2px solid var(--border-color); font-size: 1.6rem; font-weight: bold; color: var(--primary-color); }
        .booking-form-area { padding: 30px; overflow-y: auto; }
        .booking-steps { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); }
        .step-tab { padding: 10px 0; font-size: 1.1rem; font-weight: 500; color: var(--text-gray); border-bottom: 3px solid transparent; margin-bottom: -1px; }
        .step-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .contact-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .passenger-form-card { 
            background: transparent; padding: 0; border-radius: 0; margin-bottom: 25px;
        }
        .passenger-form-card h4 { margin-bottom: 15px; font-weight: 600; }
        .passenger-form-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; }
        .booking-form-area .form-group label {
            display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-gray);
        }
        .booking-form-area input, .booking-form-area select {
            width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color);
            font-size: 1rem; background-color: var(--bg-white); color: var(--text-dark);
        }
        .booking-footer { display: flex; justify-content: flex-end; align-items: center; margin-top: 30px; gap: 15px; }
        
        .back-btn { 
            background: none; border: 2px solid var(--border-color); color: var(--text-gray); 
            padding: 13px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s ease;
        }
        .back-btn:hover { background-color: var(--border-color); color: var(--text-dark); }
        .final-pay-btn { background: var(--secondary-color); margin-top: 0; }
        #next-btn { margin-top: 0; }
        .booking-footer .proceed-btn { width: auto; flex-grow: 1; }
        
        /* --- Toast Notification Styling --- */
        #toast-container {
            position: fixed; top: 85px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            display: flex; align-items: flex-start; gap: 15px;
            background-color: var(--bg-white); padding: 16px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 350px;
            transform: translateX(110%); transition: transform 0.5s ease-in-out;
            overflow: hidden; position: relative;
        }
        .toast.show { transform: translateX(0); }
        .toast-content { flex-grow: 1; }
        .toast-content strong { font-size: 1rem; color: var(--text-dark); }
        .toast-content p { font-size: 0.9rem; color: var(--text-gray); margin: 4px 0 0 0; line-height: 1.4; }
        .toast-close {
            background: none; border: none; color: var(--text-gray); font-size: 20px;
            cursor: pointer; padding: 0; line-height: 1;
        }
        .toast-progress {
            position: absolute; bottom: 0; left: 0; height: 4px;
            animation: progress-bar-anim linear forwards;
        }
        @keyframes progress-bar-anim { from { width: 100%; } to { width: 0%; } }
        
        /* Toast Types */
        .toast.success { border-left: 5px solid var(--secondary-color); }
        .toast.success .toast-icon { color: var(--secondary-color); }
        .toast.success .toast-progress { background-color: var(--secondary-color); }

        .toast.info { border-left: 5px solid var(--primary-color); }
        .toast.info .toast-icon { color: var(--primary-color); }
        .toast.info .toast-progress { background-color: var(--primary-color); }


        /* --- Responsive --- */
        @media (max-width: 768px) {
            .nav-menu { display: none; }
            .routes-layout, .booking-main-content, .passenger-form-grid, .contact-details-grid { grid-template-columns: 1fr; }
            .seat-selection-container { grid-template-columns: 1fr; }
            .selection-summary, .booking-summary-sidebar { border: none; border-top: 1px solid var(--border-color); }
        }
    </style>
</head>
<body ng-controller="RoutesController">

    <div id="toast-container"></div>
    
    <nav class="navbar">
        <div class="nav-container">
            <a href="main.html" class="logo"><i class="fas fa-bus"></i> SwiftBus</a>
            <ul class="nav-menu">
                <li><a href="main.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="virtualtours.html"><i class="fas fa-vr-cardboard"></i> Explore Tours</a></li>
                <li><a href="routes.html"><i class="fas fa-route"></i> Routes</a></li>
                <li><a href="notification.html"><i class="fas fa-bell"></i> Notifications</a></li>
                <!-- This part will be dynamically shown/hidden -->
                <li id="account-link" style="display: none;"><a href="account.html"><i class="fas fa-user"></i> Account</a></li>
                <li id="auth-links">
                    <div class="auth-links">
                        <a href="login.html" class="btn-nav login">Login</a>
                        <a href="signup.html" class="btn-nav signup">Sign Up</a>
                    </div>
                </li>
                <li><button class="theme-toggle" ng-click="toggleTheme()"><i class="fas" ng-class="{'fa-moon': !isDarkMode, 'fa-sun': isDarkMode}"></i></button></li>
            </ul>
        </div>
    </nav>

    <main id="routes-page">
        <div class="page-header">
            <h1>Explore All Routes</h1>
            <p>Find the perfect journey with our advanced filtering options.</p>
        </div>
        <div class="container routes-layout">
            <aside class="filters-sidebar">
                 <div class="filter-group">
                    <h3><i class="fas fa-bus-alt"></i> Bus Type</h3>
                    <div class="filter-options">
                        <div class="filter-option" ng-repeat="type in filterOptions.busTypes">
                            <label><input type="checkbox" ng-model="filters.busType[type]" ng-change="applyFilters()"> {{type}}</label>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <h3><i class="fas fa-clock"></i> Departure Time</h3>
                    <div class="filter-options">
                        <div class="filter-option" ng-repeat="(key, label) in filterOptions.departureTimes">
                             <label><input type="checkbox" ng-model="filters.departureTime[key]" ng-change="applyFilters()"> {{label}}</label>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <h3><i class="fas fa-wifi"></i> Amenities</h3>
                    <div class="filter-options">
                        <div class="filter-option" ng-repeat="amenity in filterOptions.amenities">
                            <label><input type="checkbox" ng-model="filters.amenities[amenity]" ng-change="applyFilters()"> {{amenity}}</label>
                        </div>
                    </div>
                </div>
            </aside>
            <div class="bus-route-list">
                <div id="route-results-info">Showing {{ filteredBuses.length }} of {{ allBuses.length }} available buses.</div>
                <div id="all-routes-list">
                    <div class="bus-result-card" ng-repeat="bus in filteredBuses">
                        <div class="bus-header">
                            <div class="bus-operator">
                                <h3>{{bus.from}} &rarr; {{bus.to}}</h3>
                                <span class="bus-type">{{bus.operator}} - {{bus.busType}}</span>
                            </div>
                            <div class="bus-rating"><i class="fas fa-star"></i> {{bus.rating}}</div>
                        </div>
                        <div class="bus-footer">
                            <div class="price-info">
                                <span class="price">₹{{bus.price}}</span>
                                <span class="seats-left">{{bus.seatsLeft}} seats left</span>
                            </div>
                            <button class="view-seats-btn" ng-click="viewSeats(bus)">
                                <i class="fas fa-couch"></i> View Seats
                            </button>
                        </div>
                    </div>
                    <p ng-if="filteredBuses.length === 0" style="text-align:center; padding: 20px; color: var(--text-gray);">No buses found matching your criteria.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-container"></div>

    <script>
        // Global state object needed for modal functions
        const AppState = { selectedSeats: [], currentBus: null, bookingDetails: {} };

        const app = angular.module('routesApp', []);
        app.controller('RoutesController', function($scope) {
            
            $scope.allBuses = generateMasterBusList();
            $scope.filteredBuses = $scope.allBuses;
            $scope.isDarkMode = false;
            
            $scope.filterOptions = {
                busTypes: ['AC Sleeper', 'AC Seater', 'Non-AC Seater', 'Volvo AC'],
                departureTimes: { morning: 'Morning (6am - 12pm)', afternoon: 'Afternoon (12pm - 6pm)', evening: 'Evening (6pm - 12am)' },
                amenities: ['WiFi', 'Charging Port', 'Water Bottle', 'Blanket']
            };
            $scope.filters = { busType: {}, departureTime: {}, amenities: {} };
            
            $scope.toggleTheme = function() {
                $scope.isDarkMode = !$scope.isDarkMode;
                document.documentElement.setAttribute('data-theme', $scope.isDarkMode ? 'dark' : 'light');

                const themeName = $scope.isDarkMode ? 'Dark' : 'Light';
                showToast({
                    message: `Switched to ${themeName} Mode`
                });
            };

            $scope.applyFilters = function() {
                // AngularJS digest cycle will update the view automatically
            };

            $scope.viewSeats = function(bus) {
                // --- LOGIN CHECK ---
                if (localStorage.getItem('swiftBusUserLoggedIn') !== 'true') {
                    showToast({ message: 'Please log in to view seats.', type: 'info' });
                    setTimeout(() => { window.location.href = 'login.html'; }, 1500);
                    return;
                }
                // --- END LOGIN CHECK ---
                viewBusSeats(bus); // Calls the global function
            };

            // This custom filter is the Angular way to process the filter checkboxes
            $scope.$watch('filters', function() {
                const selectedBusTypes = getActiveFilters($scope.filters.busType);
                const selectedTimes = getActiveFilters($scope.filters.departureTime);
                const selectedAmenities = getActiveFilters($scope.filters.amenities);
                
                $scope.filteredBuses = $scope.allBuses.filter(bus => {
                    const busTypeMatch = selectedBusTypes.length === 0 || selectedBusTypes.includes(bus.busType);
                    const departureHour = parseInt(bus.departureTime.split(':')[0]);
                    const timeMatch = selectedTimes.length === 0 || selectedTimes.some(time => {
                        if (time === 'morning' && departureHour < 12) return true;
                        if (time === 'afternoon' && departureHour >= 12 && departureHour < 18) return true;
                        if (time === 'evening' && departureHour >= 18) return true;
                        return false;
                    });
                    const amenitiesMatch = selectedAmenities.length === 0 || selectedAmenities.every(amenity => bus.amenities.includes(amenity));
                    return busTypeMatch && timeMatch && amenitiesMatch;
                });
            }, true); // The 'true' is for deep watching the filters object
            
            function getActiveFilters(filterGroup) { return Object.keys(filterGroup).filter(key => filterGroup[key]); }
        });

        // --- GLOBAL VANILLA JS FUNCTIONS FOR MODAL HANDLING ---
        
        function viewBusSeats(busData) {
            AppState.currentBus = busData;
            const seatLayout = generateSeatLayout(busData.busType, busData.seatsLeft);
            displaySeatSelection(busData, seatLayout);
        }

        function displaySeatSelection(busData, seatData) {
            const container = document.getElementById('modal-container');
            container.innerHTML = `
                <div class="modal seat-selection-modal show">
                    <div class="modal-overlay" onclick="closeCurrentModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header"><h2><i class="fas fa-bus"></i> Select Your Seats</h2><button class="close-modal" onclick="closeCurrentModal()">&times;</button></div>
                        <div class="bus-info-bar"><span>${busData.operator} - ${busData.busType}</span><span><i class="fas fa-clock"></i> ${busData.departureTime}</span></div>
                        <div class="seat-selection-container">
                            <div class="bus-layout">
                                <div class="driver-section"><span>Driver</span><div class="steering"><i class="fas fa-dharmachakra"></i></div></div>
                                <div class="seats-grid">${generateSeatHTML(seatData)}</div>
                                <div class="legend">
                                    <div class="legend-item"><div class="seat-demo available"></div><span>Available</span></div>
                                    <div class="legend-item"><div class="seat-demo booked"></div><span>Booked</span></div>
                                    <div class="legend-item"><div class="seat-demo selected"></div><span>Selected</span></div>
                                    <div class="legend-item"><div class="seat-demo window"></div><span>Window</span></div>
                                </div>
                            </div>
                            <div class="selection-summary">
                                <h3>Booking Summary</h3>
                                <div id="selected-seats-list"><p>No seats selected</p></div>
                                <div class="price-breakdown"><div class="total-price">Total: ₹<span id="total-price">0</span></div></div>
                                <button class="proceed-btn" id="proceed-booking" disabled onclick="proceedToBooking()">Proceed to Booking</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            initializeSeatSelection();
        }

        function proceedToBooking() {
            const totalPrice = AppState.selectedSeats.reduce((sum, seat) => sum + seat.price, 0);
            AppState.bookingDetails = {
                busData: AppState.currentBus,
                selectedSeats: AppState.selectedSeats,
                totalPrice: totalPrice,
            };
            showBookingProcess();
        }

        function showBookingProcess() {
            const { busData, selectedSeats, totalPrice } = AppState.bookingDetails;
            const container = document.getElementById('modal-container');
            const passengerFormsHTML = selectedSeats.map((seat, index) => `
                <div class="passenger-form-card">
                    <h4>Passenger ${index + 1} (Seat ${seat.number})</h4>
                    <div class="passenger-form-grid">
                        <div class="form-group"><label>Full Name</label><input type="text" id="name-${index}" required pattern="[a-zA-Z\\s]+" title="Please enter a valid name."></div>
                        <div class="form-group"><label>Age</label><input type="number" id="age-${index}" required min="1" max="100"></div>
                        <div class="form-group"><label>Gender</label><select id="gender-${index}" required><option value="" disabled selected>Select</option><option value="male">Male</option><option value="female">Female</option></select></div>
                    </div>
                </div>`).join('');

            container.innerHTML = `
                <div class="modal booking-process-modal show">
                    <div class="modal-overlay" onclick="closeCurrentModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header"><h2><i class="fas fa-check-circle"></i> Complete Your Booking</h2><button class="close-modal" onclick="closeCurrentModal()">&times;</button></div>
                        <div class="booking-main-content">
                            <div class="booking-summary-sidebar">
                                <p><strong>Route:</strong> ${busData.from} &rarr; ${busData.to}</p>
                                <p><strong>Bus:</strong> ${busData.operator}</p>
                                <p><strong>Seats:</strong> ${selectedSeats.map(s => s.number).join(', ')}</p>
                                <div class="summary-total">Total: ₹${totalPrice.toLocaleString()}</div>
                            </div>
                            <div class="booking-form-area">
                                <div class="booking-steps"><div class="step-tab active" id="step-tab-1">1. Details</div><div class="step-tab" id="step-tab-2">2. Payment</div></div>
                                <form id="final-booking-form" onsubmit="event.preventDefault(); processFinalBooking();">
                                    <div id="passenger-details-step" class="form-step active">
                                        <h3>Contact Details</h3>
                                        <div class="contact-details-grid">
                                            <div class="form-group"><label>Email</label><input type="email" id="contact-email" required></div>
                                            <div class="form-group"><label>Mobile</label><input type="tel" id="contact-mobile" required pattern="[6-9][0-9]{9}" title="Enter a valid 10-digit mobile number."></div>
                                        </div>
                                        <h3>Traveller(s)</h3>
                                        ${passengerFormsHTML}
                                    </div>
                                    <div id="payment-details-step" class="form-step">
                                        <h3>Payment Details</h3>
                                        <div class="form-group"><label>Card Number</label><input type="text" id="card-number" required pattern="[0-9]{13,19}" maxlength="19" title="Enter a valid card number."></div>
                                        <div class="form-group"><label>Name on Card</label><input type="text" id="card-name" required pattern="[a-zA-Z\\s]+" title="Enter the name on your card."></div>
                                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                                            <div class="form-group"><label>Expiry</label><input type="text" id="card-expiry" placeholder="MM/YY" required pattern="(0[1-9]|1[0-2])\\/([2-9][0-9])" maxlength="5" title="Enter expiry in MM/YY format."></div>
                                            <div class="form-group"><label>CVV</label><input type="text" id="card-cvv" required pattern="[0-9]{3,4}" maxlength="4" title="Enter the 3-4 digit CVV."></div>
                                        </div>
                                    </div>
                                    <div class="booking-footer">
                                        <button type="button" class="back-btn" id="back-btn" style="display:none;">Back</button>
                                        <button type="button" class="proceed-btn" id="next-btn">To Payment</button>
                                        <button type="submit" class="proceed-btn final-pay-btn" id="final-pay-btn" style="display:none;">Pay ₹${totalPrice.toLocaleString()}</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>`;
            setupBookingSteps();
        }

        function setupBookingSteps() {
            const nextBtn = document.getElementById('next-btn');
            const backBtn = document.getElementById('back-btn');
            const payBtn = document.getElementById('final-pay-btn');
            const step1 = document.getElementById('passenger-details-step');
            const step2 = document.getElementById('payment-details-step');
            const tab1 = document.getElementById('step-tab-1');
            const tab2 = document.getElementById('step-tab-2');
            
            nextBtn.addEventListener('click', () => {
                const form = document.getElementById('final-booking-form');
                if (Array.from(step1.querySelectorAll('input, select')).every(input => input.checkValidity())) {
                    step1.classList.remove('active'); step2.classList.add('active');
                    tab1.classList.remove('active'); tab2.classList.add('active');
                    nextBtn.style.display = 'none'; backBtn.style.display = 'inline-block'; payBtn.style.display = 'inline-block';
                } else {
                    form.reportValidity();
                }
            });

            backBtn.addEventListener('click', () => {
                step2.classList.remove('active'); step1.classList.add('active');
                tab2.classList.remove('active'); tab1.classList.add('active');
                payBtn.style.display = 'none'; backBtn.style.display = 'none'; nextBtn.style.display = 'inline-block';
            });
        }
        
        function showToast(options) {
            const { 
                title, 
                message, 
                type = 'info',
                iconClass = 'fa-circle-info',
                duration = 5000
            } = options;

            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            toast.innerHTML = `
                <i class="fas ${iconClass} toast-icon"></i>
                <div class="toast-content">
                    <strong>${title}</strong>
                    <p>${message}</p>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
                <div class="toast-progress" style="animation-duration: ${duration / 1000}s"></div>
            `;

            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        function processFinalBooking() {
            const form = document.getElementById('final-booking-form');
            if (form.checkValidity()) {
                // --- START: Add this logic ---
                const { busData } = AppState.bookingDetails;
                const newBooking = {
                    id: 'SB' + Math.floor(Math.random() * 90000 + 10000),
                    route: `${busData.from} to ${busData.to}`,
                    date: new Date().toISOString().split('T')[0], // Using today's date as an example
                    operator: busData.operator
                };
                const existingBookings = JSON.parse(localStorage.getItem('swiftBusBookings')) || [];
                existingBookings.push(newBooking);
                localStorage.setItem('swiftBusBookings', JSON.stringify(existingBookings));
                // --- END: Add this logic ---

                const email = document.getElementById('contact-email').value;
                closeCurrentModal();
                showToast({
                    title: 'Booking Confirmed!',
                    message: `Your e-ticket has been sent to <strong>${email}</strong>.`,
                    type: 'success',
                    iconClass: 'fa-check-circle'
                });
            } else {
                form.reportValidity();
            }
        }
        
        function closeCurrentModal() {
            const modal = document.querySelector('.modal.show');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => { modal.parentElement.innerHTML = ''; }, 300);
            }
        }

        // --- Other necessary helper functions ---
        function generateSeatLayout(busType, seatsLeft){const l={rows:9,cols:['A','B','','C','D']},s=[];let a=0;for(let r=1;r<=l.rows;r++)for(let c of l.cols){if(c==='')continue;let t=a<seatsLeft&&.4<Math.random()?"available":"booked";"available"===t&&a++;s.push({number:`${r}${c}`,row:r,col:c,status:t,price:950,isWindow:'A'===c||'D'===c})}return{seats:s,layout:l}}
        function generateSeatHTML(e){let t="";for(let l=1;l<=e.layout.rows;l++){t+='<div class="seat-row">';for(let s of e.layout.cols){if(""===s){t+="<div></div>";continue}const a=e.seats.find(e=>e.row===l&&e.col===s);a&&(t+=`<div class="seat ${a.status} ${a.isWindow?"window":""}" data-seat="${a.number}" data-price="${a.price}" ${"available"===a.status?'onclick="selectSeat(this)"':""}>${a.number}</div>`)}t+="</div>"}return t}
        function initializeSeatSelection(){AppState.selectedSeats=[],updateBookingSummary()}
        function selectSeat(e){const t=e.dataset.seat,l=parseInt(e.dataset.price);if(e.classList.contains("selected"))e.classList.remove("selected"),AppState.selectedSeats=AppState.selectedSeats.filter(e=>e.number!==t);else{if(6<=AppState.selectedSeats.length)return void alert("Maximum 6 seats can be selected.");e.classList.add("selected"),AppState.selectedSeats.push({number:t,price:l})}updateBookingSummary()}
        function updateBookingSummary(){const e=document.getElementById("selected-seats-list"),t=document.getElementById("total-price"),l=document.getElementById("proceed-booking");if(0===AppState.selectedSeats.length)return e.innerHTML="<p>No seats selected</p>",t.textContent="0",void(l.disabled=!0);e.innerHTML=AppState.selectedSeats.map(e=>`<div class="selected-seat-item"><span>Seat ${e.number}</span><span>₹${e.price}</span></div>`).join("");const s=AppState.selectedSeats.reduce((e,t)=>e+t.price,0);t.textContent=s.toLocaleString(),l.disabled=!1}
        function generateMasterBusList(){const e=[{from:"Mumbai",to:"Pune"},{from:"Delhi",to:"Jaipur"},{from:"Bengaluru",to:"Chennai"},{from:"Hyderabad",to:"Vijayawada"}],t=["AC Sleeper","AC Seater","Non-AC Seater","Volvo AC"],l=["WiFi","Charging Port","Water Bottle","Blanket"];let s=[];for(let a=0;a<20;a++){const o=e[a%e.length],r=t[a%t.length],c=Math.floor(18*Math.random())+6;s.push({id:`bus_${a+1}`,operator:`Operator ${String.fromCharCode(65+a)}`,busType:r,departureTime:`${String(c).padStart(2,"0")}:00`,rating:(3.8+1.2*Math.random()).toFixed(1),price:Math.floor(600*Math.random())+500,seatsLeft:Math.floor(30*Math.random())+5,from:o.from,to:o.to,amenities:l.slice(0,Math.floor(Math.random()*l.length)+1)})}return s}
        
        // --- UPDATE NAVBAR ON PAGE LOAD ---
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('swiftBusUserLoggedIn') === 'true';
            const accountLink = document.getElementById('account-link');
            const authLinks = document.getElementById('auth-links');

            if (isLoggedIn) {
                accountLink.style.display = 'list-item';
                authLinks.style.display = 'none';
            } else {
                accountLink.style.display = 'none';
                authLinks.style.display = 'block';
            }
        });
    </script>

</body>
</html>

